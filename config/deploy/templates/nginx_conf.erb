upstream <%= fetch(:application) %> {
  server unix:/tmp/<%= fetch(:application) %>_unicorn.sock fail_timeout=0;
}

server {
  listen 80;
  server_name www.torapic.com new.torapic.com;

  # ------
  # Redirect
  # ------

  rewrite ^ http://torapic.com$request_uri permanent;
}

server {
  listen 80;
  server_name torapic.com;
  client_max_body_size 20M;

  root <%= current_path %>/public;

  # ------
  # Log
  # ------

  access_log <%= shared_path %>/log/nginx.log;
  error_log <%= shared_path %>/log/nginx.err.log;

  # ------
  # Maintenance mode
  # ------

  set $maintenance false;
  if (-e <%= shared_path %>/tmp/maintenance.html ) {
    set $maintenance true;
  }

  # Allow specific address
  if ($remote_addr ~ \A(119.72.197.158|180.12.106.238)\z ) {
    set $maintenance false;
  }

  # Redirect to maintenance page
  if ($maintenance = true) {
    rewrite ^ /maintenance.html last;
  }

  # Locate maintenance.html
  location /maintenance.html {
    root <%= shared_path %>/tmp/;
    expires 0;
  }

  # ------
  # Default routing
  # ------

  location / {
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Client-IP $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_pass http://<%= fetch(:application) %>;
  }

  # ------
  # Cache assets
  # ------

  # location ~* \.(ico|css|js|gif|jpe?g|png)(\?[0-9]+)?$ {
  #   expires 1d;
  #   add_header  Cache-Control public;
  #   log_not_found off;
  # }

  location ~ ^/assets/ {
    expires 1d;
    add_header Cache-Control public;

    add_header ETag "";
    break;
  }

  # ------
  # Error pages
  # ------

  error_page 500 502 503 504 /500.html;
}
